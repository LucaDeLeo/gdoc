# Plan 04-02: `write` Command — Full Document Overwrite via Drive API

## Goal
Implement `gdoc write DOC_ID FILE.md` with `--force` and `--quiet` flags, using Google Drive API v3 `files.update` with media upload for markdown-to-Doc conversion, with conflict safety (block on stale read), awareness integration, and state tracking.

## Wave
2 of 2 — depends on 04-01 for state update changes (`update_state_after_command` extended to handle edit/write `command_version`).

## References
- CONTEXT.md Decisions: #2 (--quiet and write), #4 (state update), #5 (absent last_read_version), #6 (--quiet --force), #12 (post-write version)
- Existing patterns: gdoc/api/drive.py, gdoc/cli.py (cmd_cat, cmd_edit from 04-01)

---

## Tasks

### Task 1: Add `update_doc_content` to `gdoc/api/drive.py`

**Edit existing file.** Add a function for full document overwrite via media upload.

```python
def update_doc_content(doc_id: str, content: str) -> int:
    """Overwrite a Google Doc's content with markdown.

    Uploads markdown content via files.update with media, triggering
    automatic conversion to Google Docs format.

    Args:
        doc_id: The document ID.
        content: Markdown content string to upload.

    Returns:
        The new document version (int) from the API response.
    """
    import io
    from googleapiclient.http import MediaIoBaseUpload

    try:
        service = get_drive_service()
        media = MediaIoBaseUpload(
            io.BytesIO(content.encode("utf-8")),
            mimetype="text/markdown",
            resumable=False,
        )
        result = service.files().update(
            fileId=doc_id,
            body={"mimeType": "application/vnd.google-apps.document"},
            media_body=media,
            fields="version",
        ).execute()
        return int(result["version"])
    except HttpError as e:
        _translate_http_error(e, doc_id)
```

**Tests:** Add to `tests/test_api_drive.py`
- `test_update_doc_content_success`: Mock files().update().execute() → returns version int
- `test_update_doc_content_request_params`: Verify mimeType in body, media_body is MediaIoBaseUpload with text/markdown
- `test_update_doc_content_401`: HttpError 401 → AuthError
- `test_update_doc_content_403`: HttpError 403 → GdocError "Permission denied"
- `test_update_doc_content_404`: HttpError 404 → GdocError "Document not found"

### Task 2: Implement `cmd_write` in `gdoc/cli.py`

**Edit existing file.** Replace `cmd_stub` binding for write with real `cmd_write` handler.

The write command has the most complex conflict-detection logic (Decisions #2, #5, #6):

```python
def cmd_write(args) -> int:
    """Handler for `gdoc write`."""
    import os
    doc_id = _resolve_doc_id(args.doc)
    quiet = getattr(args, "quiet", False)
    force = getattr(args, "force", False)
    file_path = args.file

    # Read local file first (fail fast on missing file)
    if not os.path.isfile(file_path):
        raise GdocError(f"file not found: {file_path}", exit_code=3)
    try:
        with open(file_path) as f:
            content = f.read()
    except OSError as e:
        raise GdocError(f"cannot read file: {e}", exit_code=3)

    # Conflict detection (complex, per Decisions #2, #5, #6)
    change_info = None

    if not quiet:
        # Normal mode: full pre-flight (2 API calls + banner)
        from gdoc.notify import pre_flight
        change_info = pre_flight(doc_id, quiet=False)

        if not force:
            # Decision #5: absent last_read_version → block with specific message
            if change_info.last_read_version is None:
                raise GdocError(
                    "no read baseline. Run 'gdoc cat' first, or use --force to overwrite.",
                    exit_code=3,
                )
            # Check conflict: block if doc changed since last read
            if change_info.has_conflict:
                raise GdocError(
                    "doc changed since last read. "
                    "Run 'gdoc cat' first, or use --force to overwrite.",
                    exit_code=3,
                )
    elif not force:
        # Quiet + no force: skip full pre-flight, but do lightweight version check
        # (Decision #2: --quiet doesn't bypass safety, only --force does)
        from gdoc.state import load_state
        state = load_state(doc_id)

        # Decision #5: absent last_read_version → block
        if state is None or state.last_read_version is None:
            raise GdocError(
                "no read baseline. Run 'gdoc cat' first, or use --force to overwrite.",
                exit_code=3,
            )

        # Lightweight version check (1 API call)
        from gdoc.api.drive import get_file_version
        version_data = get_file_version(doc_id)
        current_version = version_data.get("version")
        if current_version is not None and current_version != state.last_read_version:
            raise GdocError(
                "doc changed since last read. "
                "Run 'gdoc cat' first, or use --force to overwrite.",
                exit_code=3,
            )
    # else: quiet + force → skip everything (Decision #6, full 2-call savings)

    # Upload content via Drive API
    from gdoc.api.drive import update_doc_content
    command_version = update_doc_content(doc_id, content)

    # Output
    from gdoc.format import get_output_mode, format_json
    mode = get_output_mode(args)
    if mode == "json":
        print(format_json(written=True, version=command_version))
    else:
        print("OK written")

    # Update state (Decision #4: last_version only, not last_read_version)
    from gdoc.state import update_state_after_command
    update_state_after_command(
        doc_id, change_info, command="write",
        quiet=quiet, command_version=command_version,
    )

    return 0
```

Wire in parser: change `write_p.set_defaults(func=cmd_stub)` → `write_p.set_defaults(func=cmd_write)`.

**Tests:** `tests/test_write.py`

Helper:
```python
def _make_args(**overrides):
    defaults = {
        "command": "write",
        "doc": "abc123",
        "file": "/tmp/test.md",
        "force": False,
        "json": False,
        "verbose": False,
        "quiet": False,
    }
    defaults.update(overrides)
    return SimpleNamespace(**defaults)
```

Test classes and cases:

**TestWriteBasic:**
- `test_write_success`: Mock file exists, update_doc_content returns version=42 → "OK written", exit 0
- `test_write_reads_file_content`: Verify content passed to update_doc_content matches file content
- `test_write_json_output`: --json → `{"ok": true, "written": true, "version": 42}`
- `test_write_url_input`: Full URL resolved to doc ID

**TestWriteFileErrors:**
- `test_write_file_not_found`: Non-existent file → GdocError "file not found" exit 3, NO API calls made
- `test_write_file_unreadable`: OSError on read → GdocError "cannot read file" exit 3
- `test_write_empty_file`: Empty file → still uploads (valid use case)

**TestWriteConflictNormal (not quiet, not force):**
- `test_write_blocked_on_conflict`: change_info.has_conflict=True → GdocError exit 3, update_doc_content NOT called
- `test_write_blocked_no_prior_read`: change_info.last_read_version=None → GdocError "no read baseline" exit 3
- `test_write_blocked_no_prior_read_correct_message`: Verify error says "no read baseline" (not "doc changed since last read") per Decision #5
- `test_write_proceeds_no_conflict`: change_info.has_conflict=False → update_doc_content called, exit 0
- `test_write_conflict_error_message`: Error message includes "doc changed since last read" and suggests cat or --force

**TestWriteConflictForce (not quiet, force):**
- `test_write_force_ignores_conflict`: change_info.has_conflict=True, --force → update_doc_content called, exit 0
- `test_write_force_preflight_still_runs`: pre_flight called (for banner), but conflict doesn't block
- `test_write_force_no_prior_read`: has_conflict=True (no prior read), --force → proceeds

**TestWriteQuietNoForce (quiet, not force):**
- `test_write_quiet_skips_full_preflight`: pre_flight NOT called (2 calls saved)
- `test_write_quiet_does_version_check`: get_file_version called for lightweight check
- `test_write_quiet_blocks_on_version_mismatch`: state.last_read_version=5, current_version=10 → GdocError exit 3
- `test_write_quiet_proceeds_version_match`: state.last_read_version=5, current_version=5 → update_doc_content called
- `test_write_quiet_blocks_no_state`: load_state returns None → GdocError "no read baseline" exit 3
- `test_write_quiet_blocks_no_read_version`: state exists but last_read_version=None → GdocError "no read baseline" exit 3

**TestWriteQuietForce (quiet, force):**
- `test_write_quiet_force_skips_everything`: pre_flight NOT called, get_file_version NOT called, load_state NOT called → update_doc_content called directly, exit 0
- `test_write_quiet_force_full_savings`: No API calls besides update_doc_content

**TestWriteAwareness:**
- `test_preflight_called_normal`: pre_flight called with quiet=False in normal mode
- `test_state_updated_with_version`: update_state_after_command called with command="write", command_version from update_doc_content
- `test_state_not_updated_on_conflict_block`: GdocError from conflict → no state update
- `test_state_not_updated_on_file_error`: GdocError from file read → no state update
- `test_state_updated_quiet_force`: --quiet --force → state updated with command_version, change_info=None

**TestWriteErrors:**
- `test_write_invalid_doc_id`: Invalid URL → GdocError exit 3
- `test_write_api_error`: update_doc_content raises GdocError → propagates
- `test_write_auth_error`: update_doc_content raises AuthError → propagates

### Task 3: Update integration tests in `tests/test_cli.py`

Update tests that assert edit/write return stub exit code 4.

The `test_edit_stub` test was already updated in 04-01. For write:

```python
def test_write_no_longer_stub(self):
    result = run_gdoc("write", "doc123", "/tmp/nonexistent.md")
    assert result.returncode != 4  # no longer a stub
    # Without auth, it will hit a file or auth error
```

Also verify that the CI stub gate (`check-no-stubs.sh`) passes — both `edit` and `write` should no longer contain `return 4  # STUB`.

---

## Files Changed

| File | Action | Description |
|------|--------|-------------|
| `gdoc/api/drive.py` | EDIT | Add update_doc_content function |
| `gdoc/cli.py` | EDIT | Add cmd_write handler, rewire parser |
| `tests/test_api_drive.py` | EDIT | Add update_doc_content tests |
| `tests/test_write.py` | CREATE | Write command handler tests |
| `tests/test_cli.py` | EDIT | Update write stub test |

## Verification

1. `pytest tests/test_api_drive.py -v` — all pass (including new tests)
2. `pytest tests/test_write.py -v` — all pass
3. `pytest tests/test_cli.py -v` — all pass (updated stub tests)
4. `pytest tests/ -v` — full suite passes, no regressions
5. `bash scripts/check-no-stubs.sh` — edit and write no longer detected as stubs
6. `ruff check gdoc/ tests/` — no lint errors
7. Manual check: `update_state_after_command` for write only updates `last_version`, not `last_read_version`
