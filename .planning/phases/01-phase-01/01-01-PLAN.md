---
phase: 01-phase-01
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - gdoc/__init__.py
  - gdoc/__main__.py
  - gdoc/util.py
  - gdoc/format.py
  - tests/conftest.py
  - tests/test_util.py
  - tests/test_format.py
autonomous: true

must_haves:
  truths:
    - "Any Google Docs URL or bare document ID is accepted and returns the correct ID string"
    - "Error classes GdocError and AuthError exist with correct exit codes (1 and 2)"
    - "format_error returns ERR: prefixed messages"
    - "get_output_mode returns terse by default, json when --json, verbose when --verbose"
    - "Project is installable via pip/uv with correct entry point"
  artifacts:
    - path: "pyproject.toml"
      provides: "Project metadata, hatchling build, console_script entry, dependencies"
      contains: "gdoc.cli:main"
    - path: "gdoc/__init__.py"
      provides: "Package marker and version string"
      contains: "__version__"
    - path: "gdoc/__main__.py"
      provides: "python -m gdoc entry point"
      contains: "from gdoc.cli import main"
    - path: "gdoc/util.py"
      provides: "URL-to-ID extraction, error classes, constants"
      exports: ["extract_doc_id", "GdocError", "AuthError"]
    - path: "gdoc/format.py"
      provides: "Output mode selection and formatting helpers"
      exports: ["get_output_mode", "format_success", "format_error"]
    - path: "tests/test_util.py"
      provides: "URL extraction and error class tests"
    - path: "tests/test_format.py"
      provides: "Output formatter tests"
  key_links:
    - from: "gdoc/__main__.py"
      to: "gdoc/cli.py"
      via: "import"
      pattern: "from gdoc\\.cli import main"
    - from: "pyproject.toml"
      to: "gdoc/cli.py"
      via: "console_script entry point"
      pattern: 'gdoc = "gdoc.cli:main"'
---

<objective>
Create the project foundation: Python package scaffolding with hatchling build backend, core utility module (URL-to-ID extraction, error classes), and output formatting helpers.

Purpose: Establish the package structure and leaf modules that all subsequent plans depend on. These are zero-dependency modules that can be fully tested in isolation.
Output: Installable Python package with working utilities and formatters, fully tested.
</objective>

<execution_context>
@/Users/luca/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luca/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-phase-01/CONTEXT.md
@.planning/phases/01-phase-01/01-RESEARCH.md
@gdoc.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project scaffolding</name>
  <files>pyproject.toml, gdoc/__init__.py, gdoc/__main__.py, tests/conftest.py</files>
  <action>
Create the Python package structure:

1. **pyproject.toml** — Per locked decision #10 (hatchling, Python >=3.10):
   - `[build-system]` with `requires = ["hatchling"]` and `build-backend = "hatchling.build"`
   - `[project]` with name="gdoc", version="0.1.0", description, requires-python=">=3.10"
   - `dependencies` list under `[project]` with exactly these (locked decision #5):
     ```toml
     dependencies = [
         "google-api-python-client>=2.150.0",
         "google-auth-oauthlib>=1.2.1",
         "google-auth-httplib2>=0.2.0",
     ]
     ```
     Note: PEP 621 requires `dependencies` as a key under `[project]`, NOT a separate `[project.dependencies]` table.
   - `[project.scripts]` with `gdoc = "gdoc.cli:main"` (this is a forward reference; cli.py is created in Plan 01-02)
   - `[project.optional-dependencies]` dev section: pytest>=8.0, pytest-mock>=3.14, ruff>=0.8.0
   - `[tool.pytest.ini_options]` with testpaths=["tests"], addopts="-v --tb=short"
   - `[tool.ruff]` with target-version="py310", line-length=88
   - `[tool.ruff.lint]` with select=["E", "F", "I", "N", "W", "UP"]

2. **gdoc/__init__.py** — Package marker with `__version__ = "0.1.0"` and module docstring.

3. **gdoc/__main__.py** — Entry point for `python -m gdoc`:
   ```python
   """Entry point for `python -m gdoc`."""
   import sys
   from gdoc.cli import main
   sys.exit(main())
   ```

4. **tests/conftest.py** — Empty for now, with a docstring noting shared fixtures will be added as needed.
  </action>
  <verify>
Run: `python -c "import gdoc; print(gdoc.__version__)"` outputs "0.1.0".
Run: `ls gdoc/__init__.py gdoc/__main__.py pyproject.toml tests/conftest.py` — all files exist.
  </verify>
  <done>Package structure exists with correct metadata, version, entry points, and dependency declarations. `import gdoc` succeeds and reports version 0.1.0.</done>
</task>

<task type="auto">
  <name>Task 2: Utility module with URL-to-ID extraction and error classes</name>
  <files>gdoc/util.py, tests/test_util.py</files>
  <action>
Create the utility module and its tests. Write tests first, then implementation.

**gdoc/util.py** must contain:

1. **Error classes** (used by cli.py exception handler in Plan 01-02):
   - `GdocError(Exception)` with `__init__(self, message, exit_code=1)` — base error with exit code attribute
   - `AuthError(GdocError)` with `__init__(self, message)` that sets exit_code=2

2. **URL-to-ID extraction** (locked decisions #8 for `id=` param support):
   - `extract_doc_id(input_str: str) -> str`
   - Two regex patterns, tried in order:
     - `/d/([a-zA-Z0-9_-]+)` for path-based URLs (docs.google.com/document/d/ID/edit)
     - `[?&]id=([a-zA-Z0-9_-]+)` for query-param URLs (drive.google.com/open?id=ID)
   - Fallback: if input matches `^[a-zA-Z0-9_-]+$`, treat as bare ID
   - Raises `ValueError` with descriptive message if no valid ID found
   - Strip whitespace from input before processing

3. **Constants**:
   - `CONFIG_DIR = Path.home() / ".gdoc"`
   - `TOKEN_PATH = CONFIG_DIR / "token.json"`
   - `CREDS_PATH = CONFIG_DIR / "credentials.json"`

**tests/test_util.py** must cover:
- Standard Docs URL: `https://docs.google.com/document/d/1aBcDeFg/edit` -> `1aBcDeFg`
- Standard Drive URL: `https://drive.google.com/file/d/1aBcDeFg/view` -> `1aBcDeFg`
- Query param URL: `https://drive.google.com/open?id=1aBcDeFg` -> `1aBcDeFg`
- Query param with other params: `https://drive.google.com/uc?export=download&id=1aBcDeFg` -> `1aBcDeFg`
- URL with fragment: `https://docs.google.com/document/d/1aBcDeFg/edit#heading=h.abc` -> `1aBcDeFg`
- Bare document ID: `1aBcDeFgHiJkLmNoPqRsTuVwXyZ` -> same string
- Whitespace around input: `  1aBcDeFg  ` -> `1aBcDeFg`
- Invalid input (empty string, URL with no ID, special characters): raises ValueError
- GdocError has exit_code=1 by default
- AuthError has exit_code=2
- Both are subclasses of Exception (GdocError) and GdocError (AuthError)
  </action>
  <verify>
Run: `cd /Users/luca/dev/gdoc && python -m pytest tests/test_util.py -v` — all tests pass.
  </verify>
  <done>URL-to-ID extraction handles all Google Docs/Drive URL formats including ?id= query params. Error classes provide correct exit codes. All test cases pass.</done>
</task>

<task type="auto">
  <name>Task 3: Output formatting module</name>
  <files>gdoc/format.py, tests/test_format.py</files>
  <action>
Create the output formatting module and its tests. Write tests first, then implementation.

**gdoc/format.py** must contain (pure functions, no imports from other gdoc modules):

1. `get_output_mode(args) -> str` — Returns "json" if args.json is True, "verbose" if args.verbose is True, "terse" otherwise. Use `getattr(args, "json", False)` for safety.

2. `format_success(message: str, mode: str = "terse") -> str` — For terse: returns message as-is. For json: returns `json.dumps({"ok": True, "message": message})`. For verbose: returns message as-is (verbose formatting is command-specific, added in later phases).

3. `format_error(message: str) -> str` — Returns `f"ERR: {message}"`. Per locked decision #4, this is used for ALL errors on stderr, including in --json mode.

**tests/test_format.py** must cover:
- `get_output_mode` with mock args having json=True -> "json"
- `get_output_mode` with mock args having verbose=True -> "verbose"
- `get_output_mode` with mock args having neither -> "terse"
- `get_output_mode` with args missing json/verbose attributes -> "terse" (safety)
- `format_success` in terse mode returns plain message
- `format_success` in json mode returns valid JSON with ok=True and message
- `format_error` prefixes with "ERR: "
- `format_error` with empty string returns "ERR: "

Use `types.SimpleNamespace` or `argparse.Namespace` to create mock args objects in tests.
  </action>
  <verify>
Run: `cd /Users/luca/dev/gdoc && python -m pytest tests/test_format.py -v` — all tests pass.
Run: `cd /Users/luca/dev/gdoc && python -m pytest tests/ -v` — all tests pass (util + format).
  </verify>
  <done>Output formatters correctly dispatch between terse/json/verbose modes. Error formatter consistently produces ERR: prefixed messages. All tests pass.</done>
</task>

</tasks>

<verification>
Run the full test suite:
```bash
cd /Users/luca/dev/gdoc && python -m pytest tests/ -v
```
All tests in test_util.py and test_format.py must pass.

Verify package structure:
```bash
python -c "import gdoc; print(gdoc.__version__)"
```
Must output "0.1.0".

Verify no import errors in leaf modules:
```bash
python -c "from gdoc.util import extract_doc_id, GdocError, AuthError; print('util OK')"
python -c "from gdoc.format import get_output_mode, format_success, format_error; print('format OK')"
```
</verification>

<success_criteria>
- pyproject.toml exists with hatchling build backend, correct dependencies, and console_script entry point
- gdoc package is importable with __version__ == "0.1.0"
- extract_doc_id handles all URL formats (path /d/ID, query ?id=ID, bare ID)
- GdocError and AuthError have correct exit codes (1 and 2)
- Output formatters work for terse, json, and verbose modes
- format_error always returns ERR: prefixed string
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-phase-01/01-01-SUMMARY.md`
</output>
