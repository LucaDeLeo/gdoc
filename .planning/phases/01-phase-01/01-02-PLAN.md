---
phase: 01-phase-01
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - gdoc/cli.py
  - scripts/check-no-stubs.sh
  - tests/test_cli.py
autonomous: true

must_haves:
  truths:
    - "Running `gdoc` with no command prints help to stderr and exits with code 3"
    - "Running `gdoc` with an invalid flag exits with code 3 (not argparse default 2)"
    - "Running `gdoc --json --verbose` fails with mutual exclusivity error (exit 3)"
    - "Running `gdoc ls` (or any unimplemented stub) prints ERR message to stderr and exits with code 4"
    - "Running `gdoc auth --help` shows --no-browser option"
    - "check-no-stubs.sh detects return 4 in gdoc/ source files"
  artifacts:
    - path: "gdoc/cli.py"
      provides: "CLI parser, subcommand dispatch, exception handler"
      exports: ["main", "build_parser", "GdocArgumentParser"]
    - path: "scripts/check-no-stubs.sh"
      provides: "CI gate preventing stub code from shipping"
    - path: "tests/test_cli.py"
      provides: "CLI argument parsing and exit code tests"
  key_links:
    - from: "gdoc/cli.py"
      to: "gdoc/util.py"
      via: "import error classes"
      pattern: "from gdoc\\.util import.*GdocError.*AuthError"
    - from: "gdoc/cli.py"
      to: "gdoc/format.py"
      via: "import format helpers"
      pattern: "from gdoc\\.format import"
    - from: "gdoc/cli.py"
      to: "main()"
      via: "top-level exception handler"
      pattern: "except AuthError.*return 2"
---

<objective>
Build the CLI infrastructure: custom argument parser with correct exit codes, global output flags, all subcommand registrations (stubs for future phases), top-level exception handler, and a CI gate to prevent stubs from shipping.

Purpose: Establish the CLI framework that all future commands plug into. Every locked decision about argument parsing, exit codes, and error formatting is implemented here.
Output: Working `gdoc` command with help text, correct exit codes, and stub commands.
</objective>

<execution_context>
@/Users/luca/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luca/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-phase-01/CONTEXT.md
@.planning/phases/01-phase-01/01-RESEARCH.md
@.planning/phases/01-phase-01/01-01-SUMMARY.md
@gdoc.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: CLI parser with custom exit codes and subcommand registration</name>
  <files>gdoc/cli.py</files>
  <action>
Create the full CLI infrastructure in gdoc/cli.py.

**1. GdocArgumentParser subclass** (locked decision #1):
```python
class GdocArgumentParser(argparse.ArgumentParser):
    def error(self, message: str) -> None:
        self.print_usage(sys.stderr)
        print(f"ERR: {message}", file=sys.stderr)
        sys.exit(3)
```
This overrides argparse's default exit code 2 to use exit code 3 for usage errors. The `ERR:` prefix matches locked decision #4.

**2. build_parser() function** that creates the argument structure:
- Top-level parser: prog="gdoc", description="CLI for Google Docs & Drive"
- Global mutually exclusive group (locked decision #3): `--json` and `--verbose`
- Subparsers with `dest="command"` (do NOT set `required=True` — we handle missing command manually to control exit behavior)
- Register ALL subcommands from gdoc.md:
  - `auth` with `--no-browser` flag (locked decision #9)
  - `ls` with optional positional `folder_id`, `--type` choices=["docs", "sheets", "all"]
  - `find` with required positional `query`
  - `cat` with required positional `doc`, `--comments`, `--plain` (mutually exclusive), `--quiet`
  - `edit` with positional `doc`, `old_text`, `new_text`, `--all`, `--quiet`, `--case-sensitive`
  - `write` with positional `doc`, `file`, `--force`, `--quiet`
  - `comments` with positional `doc`, `--all`
  - `comment` with positional `doc`, `text`
  - `reply` with positional `doc`, `comment_id`, `text`
  - `resolve` with positional `doc`, `comment_id`
  - `reopen` with positional `doc`, `comment_id`
  - `info` with positional `doc`
  - `share` with positional `doc`, `email`, `--role` choices=["reader", "writer", "commenter"]
  - `new` with positional `title`, `--folder`
  - `cp` with positional `doc`, `title`
- Each subparser sets `func` via `set_defaults(func=cmd_stub)` except `auth` which also uses `cmd_stub` for now (real handler wired in Plan 01-03).
- Use `--quiet` flag on subcommands that take a doc argument (cat, edit, write, comments, comment, reply, resolve, reopen, info). Add it per-subparser, not globally.

**3. cmd_stub handler** (locked decision #2):
```python
def cmd_stub(args) -> int:
    print(f"ERR: {args.command} is not yet implemented", file=sys.stderr)
    return 4  # STUB — removed when real implementation added
```
The `# STUB` comment is important for the CI gate grep pattern.

**4. main() function** with top-level exception handler (locked decision #4):
```python
def main() -> int:
    parser = build_parser()
    args = parser.parse_args()

    if args.command is None:
        parser.print_help(sys.stderr)
        return 3

    try:
        return args.func(args)
    except AuthError as e:
        print(f"ERR: {e}", file=sys.stderr)
        return 2
    except GdocError as e:
        print(f"ERR: {e}", file=sys.stderr)
        return e.exit_code
    except Exception as e:
        print(f"ERR: unexpected error: {e}", file=sys.stderr)
        return 1
```

Import `GdocError` and `AuthError` from `gdoc.util`.

**Important implementation notes:**
- Do NOT use `argparse.Namespace` type hints — just use the default.
- Use `sys.exit(main())` only in `__main__.py`, not in cli.py. `main()` returns an int.
- All error output goes to stderr via `file=sys.stderr` (locked decision #4, requirement OUT-06).
  </action>
  <verify>
Run: `cd /Users/luca/dev/gdoc && python -m gdoc 2>&1; echo "exit: $?"` — shows help text and exits with code 3.
Run: `cd /Users/luca/dev/gdoc && python -m gdoc ls 2>&1; echo "exit: $?"` — shows "ERR: ls is not yet implemented" and exits with code 4.
Run: `cd /Users/luca/dev/gdoc && python -m gdoc --json --verbose 2>&1; echo "exit: $?"` — shows mutual exclusivity error and exits with code 3.
Run: `cd /Users/luca/dev/gdoc && python -m gdoc auth --help` — shows --no-browser in help.
  </verify>
  <done>CLI parser handles all subcommands, enforces exit code 3 on usage errors, exit code 4 on stubs, and provides mutually exclusive --json/--verbose flags.</done>
</task>

<task type="auto">
  <name>Task 2: CI gate and CLI tests</name>
  <files>scripts/check-no-stubs.sh, tests/test_cli.py</files>
  <action>
**1. scripts/check-no-stubs.sh** (locked decision #2 enforcement):
```bash
#!/usr/bin/env bash
# CI release gate: fails if any stub exit-code-4 paths remain.
# Stubs are marked with "# STUB" comment on the return line.
set -euo pipefail

if grep -rn 'return 4.*# STUB' gdoc/ --include='*.py'; then
    echo "FAIL: stub exit code 4 found — all stubs must be replaced before release"
    exit 1
fi
echo "OK: no stubs found"
exit 0
```
Make the script executable: `chmod +x scripts/check-no-stubs.sh`.

Note: The pattern `return 4.*# STUB` is more specific than just `return 4` to avoid false positives (per research open question #2). Every stub return in cli.py must have the `# STUB` comment.

**2. tests/test_cli.py** — comprehensive CLI tests:

Test categories:

a) **Exit code 3 on usage errors** (locked decision #1):
   - `gdoc` with no arguments → exit 3
   - `gdoc --bad-flag` → exit 3
   - `gdoc cat` (missing required doc argument) → exit 3

b) **Exit code 4 on stub commands** (locked decision #2):
   - `gdoc ls` → exit 4, stderr contains "ERR: ls is not yet implemented"
   - `gdoc cat some-doc-id` → exit 4 (still a stub)
   - `gdoc find "query"` → exit 4

c) **Mutually exclusive flags** (locked decision #3):
   - `gdoc --json --verbose ls` → exit 3
   - `gdoc --json ls` → exit 4 (flag accepted, stub runs)
   - `gdoc --verbose ls` → exit 4 (flag accepted, stub runs)

d) **Help text**:
   - `gdoc --help` → exit 0, stdout contains "auth" and "cat" and "edit"
   - `gdoc auth --help` → exit 0, stdout contains "--no-browser"

e) **Error format** (locked decision #4):
   - All stderr error messages start with "ERR: "

**Testing approach:** Use `subprocess.run(['python', '-m', 'gdoc', ...], capture_output=True, text=True)` for exit code verification. This tests the actual CLI as a user would invoke it. Set `cwd` to the project root.

Alternatively, test by calling `main()` directly with patched `sys.argv` and capturing the return code. This is faster but less realistic. Use the subprocess approach for exit code tests (most reliable) and the direct approach for internal behavior tests.
  </action>
  <verify>
Run: `cd /Users/luca/dev/gdoc && python -m pytest tests/test_cli.py -v` — all tests pass.
Run: `cd /Users/luca/dev/gdoc && bash scripts/check-no-stubs.sh; echo "exit: $?"` — exits with 1 (stubs exist, as expected at this stage).
Run: `cd /Users/luca/dev/gdoc && python -m pytest tests/ -v` — full suite passes (util + format + cli).
  </verify>
  <done>CI gate correctly detects stub code. CLI tests verify all exit code behaviors (3 for usage, 4 for stubs), mutual exclusivity of --json/--verbose, and ERR: error format on stderr.</done>
</task>

</tasks>

<verification>
Run the full test suite:
```bash
cd /Users/luca/dev/gdoc && python -m pytest tests/ -v
```
All tests must pass.

Manual CLI verification:
```bash
# No command → help + exit 3
python -m gdoc; echo $?

# Stub → ERR message + exit 4
python -m gdoc ls 2>&1; echo $?

# Mutual exclusivity → exit 3
python -m gdoc --json --verbose ls 2>&1; echo $?

# Help → exit 0
python -m gdoc --help; echo $?
```

CI gate:
```bash
bash scripts/check-no-stubs.sh
# Expected: FAIL (stubs exist) with exit 1
```
</verification>

<success_criteria>
- GdocArgumentParser.error() emits exit code 3, not argparse default 2
- All subcommands from gdoc.md are registered (auth, ls, find, cat, edit, write, comments, comment, reply, resolve, reopen, info, share, new, cp)
- --json and --verbose are mutually exclusive
- Stub commands print ERR: message to stderr and exit with code 4
- main() catches AuthError (exit 2), GdocError (exit N), and unexpected exceptions (exit 1)
- No command shows help and exits with code 3
- scripts/check-no-stubs.sh detects stub markers in source code
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-phase-01/01-02-SUMMARY.md`
</output>
