---
phase: 02-read-operations
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - gdoc/api/__init__.py
  - gdoc/api/drive.py
  - gdoc/format.py
  - gdoc/util.py
  - tests/test_api_drive.py
  - tests/test_util.py
  - tests/test_format.py
autonomous: true

must_haves:
  truths:
    - "Drive API service is cached and reused across calls within a single CLI invocation"
    - "export_doc returns decoded UTF-8 string from Drive API export"
    - "list_files auto-paginates and returns all matching files"
    - "search_files escapes backslashes then single quotes before embedding in query"
    - "get_file_info returns metadata dict with nested owner fields"
    - "HttpError 401 raises AuthError, 403/404/other raise GdocError with correct messages"
    - "format_json wraps data with ok=True and returns JSON string"
    - "extract_doc_id handles /folders/ URLs for Drive folder links"
  artifacts:
    - path: "gdoc/api/__init__.py"
      provides: "Drive service factory"
      exports: ["get_drive_service"]
    - path: "gdoc/api/drive.py"
      provides: "Drive API wrapper functions"
      exports: ["export_doc", "list_files", "search_files", "get_file_info"]
    - path: "gdoc/format.py"
      provides: "format_json helper"
      exports: ["format_json"]
    - path: "tests/test_api_drive.py"
      provides: "API wrapper unit tests"
  key_links:
    - from: "gdoc/api/__init__.py"
      to: "gdoc/auth.py"
      via: "get_credentials() call in get_drive_service()"
      pattern: "get_credentials"
    - from: "gdoc/api/drive.py"
      to: "gdoc/api/__init__.py"
      via: "get_drive_service() import"
      pattern: "from gdoc.api import get_drive_service"
    - from: "gdoc/api/drive.py"
      to: "gdoc/util.py"
      via: "GdocError and AuthError imports"
      pattern: "from gdoc.util import"
---

<objective>
Create the Drive API wrapper layer, format_json helper, and folder URL support that all Phase 2 commands depend on.

Purpose: Every read command (cat, ls, find, info) needs a service object, API wrapper functions with error translation, and JSON formatting. This plan builds and tests that foundation before any command handler touches it.

Output: `gdoc/api/` package with service factory and Drive wrappers, updated `format.py` and `util.py`, comprehensive unit tests.
</objective>

<execution_context>
@/Users/luca/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luca/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-phase-02/02-RESEARCH.md
@.planning/phases/02-phase-02/CONTEXT.md
@gdoc/util.py
@gdoc/format.py
@gdoc/auth.py
@tests/test_util.py
@tests/test_format.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API package and utility updates</name>
  <files>
    gdoc/api/__init__.py
    gdoc/api/drive.py
    gdoc/format.py
    gdoc/util.py
  </files>
  <action>
    **1. Create `gdoc/api/__init__.py`:**
    ```python
    from functools import lru_cache
    from googleapiclient.discovery import build

    @lru_cache(maxsize=1)
    def get_drive_service():
        from gdoc.auth import get_credentials
        creds = get_credentials()
        return build("drive", "v3", credentials=creds)
    ```
    Lazy import of `get_credentials` to avoid import errors when module is loaded without Google libraries available.

    **2. Create `gdoc/api/drive.py`:**

    `_translate_http_error(e: HttpError, file_id: str) -> None`:
    - Import `HttpError` from `googleapiclient.errors`
    - 401 -> `raise AuthError("Authentication expired. Run \`gdoc auth\`.")`
    - 403 -> Check if error reason contains "Export only supports Docs Editors files". If so, raise `GdocError(f"Cannot export file as markdown: file is not a Google Docs editor document")`. Otherwise raise `GdocError(f"Permission denied: {file_id}")`
    - 404 -> `raise GdocError(f"Document not found: {file_id}")`
    - Other -> `raise GdocError(f"API error ({status}): {e.reason}")`

    `_escape_query_value(value: str) -> str`:
    - Escape backslashes FIRST: `value.replace("\\", "\\\\")`
    - Then single quotes: `value.replace("'", "\\'")`
    - Return escaped value

    `export_doc(doc_id: str, mime_type: str = "text/markdown") -> str`:
    - Call `get_drive_service().files().export_media(fileId=doc_id, mimeType=mime_type)`
    - `.execute()` returns bytes; decode with `.decode("utf-8")`
    - Wrap in try/except HttpError, call `_translate_http_error(e, doc_id)`

    `list_files(query: str) -> list[dict]`:
    - Auto-paginate: loop calling `files().list(q=query, fields="nextPageToken, files(id, name, mimeType, modifiedTime)", pageSize=100, pageToken=page_token)`
    - Extend `all_files` list with `response.get("files", [])`
    - Break when `nextPageToken` is None
    - Wrap in try/except HttpError, call `_translate_http_error(e, "")`

    `search_files(query: str) -> list[dict]`:
    - Escape query with `_escape_query_value(query)`
    - Build Drive query: `f"(name contains '{escaped}' or fullText contains '{escaped}') and trashed=false"`
    - Call and return `list_files(drive_query)`

    `get_file_info(doc_id: str) -> dict`:
    - Call `files().get(fileId=doc_id, fields="id, name, mimeType, modifiedTime, createdTime, owners(emailAddress, displayName), lastModifyingUser(emailAddress, displayName), size")`
    - `.execute()` returns dict
    - Wrap in try/except HttpError, call `_translate_http_error(e, doc_id)`

    **3. Add `format_json` to `gdoc/format.py`:**
    ```python
    def format_json(**data) -> str:
        return json.dumps({"ok": True, **data})
    ```
    Add after existing `format_error` function.

    **4. Add `/folders/` pattern to `gdoc/util.py`:**
    Add `re.compile(r"/folders/([a-zA-Z0-9_-]+)")` to `_PATTERNS` list (after the existing two patterns). This enables `extract_doc_id()` to handle folder URLs like `https://drive.google.com/drive/folders/1aBcDeFg`.
  </action>
  <verify>
    `.venv/bin/python -c "from gdoc.api import get_drive_service; from gdoc.api.drive import export_doc, list_files, search_files, get_file_info; from gdoc.format import format_json; print('imports OK')"`
    `.venv/bin/python -c "from gdoc.util import extract_doc_id; assert extract_doc_id('https://drive.google.com/drive/folders/abc123') == 'abc123'; print('folder URL OK')"`
    `.venv/bin/python -c "from gdoc.format import format_json; import json; result = json.loads(format_json(content='hello')); assert result == {'ok': True, 'content': 'hello'}; print('format_json OK')"`
  </verify>
  <done>
    All four source files exist with the specified functions. Imports succeed. `extract_doc_id` handles folder URLs. `format_json` produces correct JSON.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test API wrappers, format_json, and folder URL support</name>
  <files>
    tests/test_api_drive.py
    tests/test_util.py
    tests/test_format.py
  </files>
  <action>
    **TDD approach: Write tests RED, then verify GREEN after Task 1 code.**

    **1. Create `tests/test_api_drive.py`:**

    Use `unittest.mock.patch` and `unittest.mock.MagicMock` to mock the Drive service. Do NOT call real Google APIs.

    Test classes:

    `TestExportDoc`:
    - `test_export_markdown_default`: Mock `get_drive_service` to return a mock service. Mock `service.files().export_media().execute()` to return `b"# Hello"`. Assert `export_doc("abc123")` returns `"# Hello"`.
    - `test_export_plain_text`: Same but with `mime_type="text/plain"`, mock returns `b"Hello"`.
    - `test_export_not_found`: Mock `export_media().execute()` to raise `HttpError(httplib2.Response({"status": "404"}), b'Not Found')`. Assert raises `GdocError` with "Document not found".
    - `test_export_auth_expired`: Mock raises HttpError 401. Assert raises `AuthError`.
    - `test_export_permission_denied`: Mock raises HttpError 403 (without export-specific message). Assert raises `GdocError` with "Permission denied".
    - `test_export_non_exportable_file`: Mock raises HttpError 403 with reason containing "Export only supports Docs Editors files". Assert raises `GdocError` with "Cannot export file as markdown".

    `TestListFiles`:
    - `test_single_page`: Mock `files().list().execute()` returns `{"files": [{"id": "1", "name": "Doc"}]}` (no nextPageToken). Assert returns list with one dict.
    - `test_multiple_pages`: First call returns `{"files": [...], "nextPageToken": "token2"}`, second call returns `{"files": [...]}`. Assert returns combined list.
    - `test_empty_result`: Mock returns `{"files": []}`. Assert returns empty list.

    `TestSearchFiles`:
    - `test_basic_search`: Mock `list_files`. Call `search_files("hello")`. Assert the query passed to `list_files` contains `name contains 'hello'` and `fullText contains 'hello'` and `trashed=false`.
    - `test_escapes_single_quotes`: Call `search_files("it's")`. Assert query contains `it\\'s`.
    - `test_escapes_backslash_first`: Call `search_files("a\\b")`. Assert backslash escaped before quotes.

    `TestGetFileInfo`:
    - `test_returns_metadata`: Mock `files().get().execute()` returns dict with id, name, mimeType, etc. Assert `get_file_info("abc")` returns that dict.
    - `test_not_found`: Mock raises HttpError 404. Assert raises `GdocError`.

    `TestEscapeQueryValue`:
    - `test_no_special_chars`: Assert `_escape_query_value("hello")` returns `"hello"`.
    - `test_single_quote`: Assert `_escape_query_value("it's")` returns `"it\\'s"`.
    - `test_backslash`: Assert `_escape_query_value("a\\b")` returns `"a\\\\b"`.
    - `test_both`: Assert `_escape_query_value("it\\'s")` — backslash first, then quote.

    `TestTranslateHttpError`:
    - `test_401_raises_auth_error`: Assert raises `AuthError` with "Authentication expired".
    - `test_403_raises_gdoc_error`: Assert raises `GdocError` with "Permission denied".
    - `test_404_raises_gdoc_error`: Assert raises `GdocError` with "Document not found".
    - `test_500_raises_gdoc_error`: Assert raises `GdocError` with "API error (500)".

    For creating mock `HttpError` objects: Use `httplib2.Response({"status": str(code)})` as the response parameter and `b""` as content. Set `reason` attribute on the error as needed.

    **2. Add to `tests/test_util.py`:**

    Add tests to existing test file:
    - `test_folder_url`: Assert `extract_doc_id("https://drive.google.com/drive/folders/1aBcDeFg")` returns `"1aBcDeFg"`.
    - `test_folder_url_with_params`: Assert `extract_doc_id("https://drive.google.com/drive/folders/abc123?usp=sharing")` returns `"abc123"`.

    **3. Add to `tests/test_format.py`:**

    Add tests to existing test file:
    - `test_format_json_single_field`: Assert `format_json(content="hello")` equals `'{"ok": true, "content": "hello"}'` (compare parsed JSON).
    - `test_format_json_multiple_fields`: Assert `format_json(a=1, b="two")` includes `ok=True`, `a=1`, `b="two"`.
    - `test_format_json_nested`: Assert `format_json(files=[{"id": "1"}])` produces correct JSON structure.
  </action>
  <verify>
    `.venv/bin/python -m pytest tests/test_api_drive.py tests/test_util.py tests/test_format.py -v`
    All new tests pass. Existing tests still pass: `.venv/bin/python -m pytest tests/ -v`
  </verify>
  <done>
    All API wrapper tests pass with mocked Google API calls. Folder URL extraction tests pass. format_json tests pass. Full test suite still green (50+ existing tests unbroken).
  </done>
</task>

</tasks>

<verification>
1. `gdoc/api/__init__.py` exists with `get_drive_service()` decorated with `@lru_cache(maxsize=1)`
2. `gdoc/api/drive.py` exports `export_doc`, `list_files`, `search_files`, `get_file_info`
3. `gdoc/format.py` exports `format_json`
4. `gdoc/util.py` handles `/folders/` pattern in `extract_doc_id`
5. `tests/test_api_drive.py` has 15+ tests covering all API wrappers and error translation
6. `.venv/bin/python -m pytest tests/ -v` — all tests pass
</verification>

<success_criteria>
- API wrapper functions importable and type-correct
- Error translation covers 401, 403, 403-export, 404, and other status codes
- Query escaping handles backslashes before single quotes
- format_json produces `{"ok": true, ...}` JSON strings
- extract_doc_id handles folder URLs
- All tests pass (existing + new)
</success_criteria>

<output>
After completion, create `.planning/phases/02-phase-02/02-01-SUMMARY.md`
</output>
