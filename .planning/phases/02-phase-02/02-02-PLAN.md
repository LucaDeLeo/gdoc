---
phase: 02-read-operations
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - gdoc/cli.py
  - tests/test_cat.py
  - tests/test_info.py
  - tests/test_cli.py
autonomous: true

must_haves:
  truths:
    - "gdoc cat DOC_ID prints markdown content to stdout with no wrapper"
    - "gdoc cat DOC_ID --plain prints plain text content to stdout"
    - "gdoc cat DOC_ID --json outputs {ok: true, content: '...'}"
    - "gdoc cat DOC_ID --comments prints ERR message and exits 4 (stub)"
    - "gdoc info DOC_ID prints Title, Owner, Modified, Words in terse mode (Words: N/A for non-text-exportable files including Forms, Drawings, PDFs)"
    - "gdoc info DOC_ID --verbose adds Created, Last editor, Type, Size"
    - "gdoc info DOC_ID --json outputs flat metadata object with ok: true"
    - "Invalid doc ID or URL produces exit code 3 with ERR message"
  artifacts:
    - path: "gdoc/cli.py"
      provides: "cmd_cat, cmd_info, _resolve_doc_id handlers"
      contains: "def cmd_cat"
    - path: "tests/test_cat.py"
      provides: "cat command tests"
    - path: "tests/test_info.py"
      provides: "info command tests"
  key_links:
    - from: "gdoc/cli.py cmd_cat"
      to: "gdoc/api/drive.py export_doc"
      via: "lazy import and function call"
      pattern: "from gdoc.api.drive import export_doc"
    - from: "gdoc/cli.py cmd_info"
      to: "gdoc/api/drive.py get_file_info"
      via: "lazy import and function call"
      pattern: "from gdoc.api.drive import.*get_file_info"
    - from: "gdoc/cli.py cmd_info"
      to: "gdoc/api/drive.py export_doc"
      via: "word count computation"
      pattern: "export_doc.*text/plain"
---

<objective>
Implement `cat` and `info` CLI commands that export document content and display metadata.

Purpose: These are the two single-document read commands. `cat` is the most fundamental operation (read a doc), and `info` provides metadata context. Both use `export_doc` and `get_file_info` from the API layer built in Plan 01.

Output: Working `cmd_cat` and `cmd_info` handlers in `cli.py`, comprehensive tests in `test_cat.py` and `test_info.py`.
</objective>

<execution_context>
@/Users/luca/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luca/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-phase-02/CONTEXT.md
@.planning/phases/02-phase-02/02-01-SUMMARY.md
@gdoc/cli.py
@gdoc/api/drive.py
@gdoc/format.py
@gdoc/util.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement cmd_cat, cmd_info, and _resolve_doc_id in cli.py</name>
  <files>gdoc/cli.py</files>
  <action>
    **1. Add `_resolve_doc_id` helper** (before `cmd_auth`):
    ```python
    def _resolve_doc_id(raw: str) -> str:
        """Extract doc ID, wrapping ValueError as GdocError(exit_code=3)."""
        from gdoc.util import extract_doc_id
        try:
            return extract_doc_id(raw)
        except ValueError as e:
            raise GdocError(str(e), exit_code=3)
    ```

    **2. Add `cmd_cat` handler:**
    - Resolve doc_id: `doc_id = _resolve_doc_id(args.doc)`
    - Check `--comments` flag: if `getattr(args, "comments", False)`, print `ERR: cat --comments is not yet implemented` to stderr and `return 4  # STUB — removed when real implementation added` (matches Phase 1 stub pattern, keeps CI gate active)
    - Determine mime_type: `"text/plain"` if `getattr(args, "plain", False)` else `"text/markdown"`
    - Lazy import: `from gdoc.api.drive import export_doc`
    - Call: `content = export_doc(doc_id, mime_type=mime_type)`
    - Output based on mode:
      - `get_output_mode(args)` from `gdoc.format`
      - If `"json"`: `from gdoc.format import format_json` then `print(format_json(content=content))`
      - Otherwise: `print(content, end="")` — raw to stdout, no trailing newline added (unix cat semantics; the content itself may end with newline)
    - Return 0

    **3. Add `cmd_info` handler:**
    - Resolve doc_id: `doc_id = _resolve_doc_id(args.doc)`
    - Lazy imports: `from gdoc.api.drive import get_file_info, export_doc` and `from gdoc.format import get_output_mode, format_json`
    - Get metadata: `metadata = get_file_info(doc_id)`
    - Get word count (only for files exportable to text/plain):
      - Define exportable suffixes: `_TEXT_EXPORTABLE = {"document", "spreadsheet", "presentation"}` — these are the Google Workspace editor types that support `text/plain` export per the official export MIME types table. Notably, `drawing` (image-only export) and `form` (not exportable at all) are excluded.
      - Check `metadata.get("mimeType", "")`. If it starts with `"application/vnd.google-apps."` AND its suffix (after the last `.`) is in `_TEXT_EXPORTABLE`:
        - Try: `text = export_doc(doc_id, mime_type="text/plain")` then `word_count = len(text.split())`
        - Except `GdocError`: `word_count = None` — graceful fallback if export fails unexpectedly (e.g. API changes, edge-case file types). This ensures `info` never crashes due to word-count computation.
      - Otherwise (e.g. uploaded PDFs, images, binary files, Forms, Drawings): `word_count = None`
      - This avoids calling `export_doc` on non-exportable files, which would fail with a 403 error. Per CONTEXT.md decision #4, `info` should work on any Drive file.
    - Extract fields:
      - `title = metadata.get("name", "")`
      - `owners = metadata.get("owners", [])`
      - `owner_info = owners[0] if owners else {}`
      - `owner = owner_info.get("displayName") or owner_info.get("emailAddress", "Unknown")`
      - `modified = metadata.get("modifiedTime", "")`
      - `created = metadata.get("createdTime", "")`
      - `last_editor_info = metadata.get("lastModifyingUser", {})`
      - `last_editor = last_editor_info.get("displayName") or last_editor_info.get("emailAddress", "")`
      - `mime_type = metadata.get("mimeType", "")`
      - `size = metadata.get("size")` (may be None)
    - Date formatting:
      - Terse: truncate to `YYYY-MM-DD` (first 10 chars of ISO 8601)
      - Verbose: full ISO 8601 as returned by API
    - Output modes:
      - **Terse:**
        ```
        Title: {title}
        Owner: {owner}
        Modified: {modified[:10]}
        Words: {word_count or "N/A"}
        ```
      - **Verbose:** Add extra lines:
        ```
        Title: {title}
        Owner: {owner}
        Modified: {modified}
        Created: {created}
        Last editor: {last_editor}
        Type: {mime_type}
        Size: {size or "N/A"}
        Words: {word_count or "N/A"}
        ```
      - **JSON:**
        ```python
        print(format_json(
            id=doc_id,
            title=title,
            owner=owner,
            modified=modified,
            words=word_count,  # None for non-exportable files
        ))
        ```
    - Return 0

    **4. Wire commands in `build_parser()`:**
    - Change `cat_p.set_defaults(func=cmd_stub)` to `cat_p.set_defaults(func=cmd_cat)`
    - Change `info_p.set_defaults(func=cmd_stub)` to `info_p.set_defaults(func=cmd_info)`
    - Keep all other commands pointing to `cmd_stub`

    **5. Update `tests/test_cli.py`:**
    - Remove `test_cat_stub` from `TestExitCode4OnStubs` (cat is no longer a stub)
    - Keep `test_ls_stub` and `test_find_stub` (still stubs until Plan 03)
    - The existing stub tests for other commands (edit, write, etc.) are unaffected
    - **Update `TestMutuallyExclusiveFlags`:** `test_json_after_subcommand` currently runs `info 1aBcDeFg --json` and asserts returncode == 4. Since `info` is no longer a stub, change this test to use a still-stubbed command: `run_gdoc("edit", "1aBcDeFg", "old", "new", "--json")` and assert returncode == 4. The test's purpose is to verify `--json` is accepted after a subcommand, which is parser behavior independent of the specific command.
  </action>
  <verify>
    `.venv/bin/python -c "from gdoc.cli import cmd_cat, cmd_info, _resolve_doc_id; print('handlers OK')"`
    `.venv/bin/python -m pytest tests/test_cli.py -v` (existing tests still pass, cat stub test removed)
  </verify>
  <done>
    `cmd_cat` and `cmd_info` are wired in `build_parser()`. `_resolve_doc_id` helper exists. `cat` and `info` no longer return exit code 4. Existing CLI tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test cat and info commands</name>
  <files>
    tests/test_cat.py
    tests/test_info.py
  </files>
  <action>
    Use `unittest.mock.patch` to mock `gdoc.api.drive` functions. Do NOT call real Google APIs. Test at the command handler level by calling `cmd_cat(args)` / `cmd_info(args)` with `SimpleNamespace` args, capturing stdout with `capsys` (pytest fixture).

    Also mock `gdoc.api.get_drive_service` in all tests to prevent any attempt to build a real Drive service. Use `@patch("gdoc.api.drive.get_drive_service")` or patch at the import location.

    **1. Create `tests/test_cat.py`:**

    `TestCatMarkdown`:
    - `test_cat_default_markdown`: Patch `export_doc` to return `"# Hello World\n"`. Call `cmd_cat` with `SimpleNamespace(doc="abc123", plain=False, comments=False, json=False, verbose=False, command="cat")`. Assert stdout is `"# Hello World\n"` (raw, no extra newline). Assert `export_doc` called with `("abc123", mime_type="text/markdown")`.
    - `test_cat_url_input`: Patch `export_doc`. Call with `doc="https://docs.google.com/document/d/abc123/edit"`. Assert `export_doc` called with `"abc123"`.

    `TestCatPlain`:
    - `test_cat_plain`: Patch `export_doc` to return `"Hello World\n"`. Call with `plain=True`. Assert `export_doc` called with `mime_type="text/plain"`.

    `TestCatJson`:
    - `test_cat_json_mode`: Patch `export_doc` to return `"# Hello"`. Call with `json=True`. Parse stdout as JSON. Assert `{"ok": true, "content": "# Hello"}`.

    `TestCatComments`:
    - `test_cat_comments_stub`: Call with `comments=True`. Assert return value is 4. Assert stderr contains "not yet implemented".

    `TestCatErrors`:
    - `test_cat_invalid_doc_id`: Call with `doc="!!invalid!!"`. Assert raises `GdocError` with exit_code 3.
    - `test_cat_empty_doc_id`: Call with `doc=""`. Assert raises `GdocError` with exit_code 3.
    - `test_cat_api_error`: Patch `export_doc` to raise `GdocError("Document not found: abc")`. Assert raises `GdocError`.

    **2. Create `tests/test_info.py`:**

    Create a shared mock metadata dict fixture:
    ```python
    MOCK_METADATA = {
        "id": "abc123",
        "name": "Test Document",
        "mimeType": "application/vnd.google-apps.document",
        "modifiedTime": "2025-01-15T10:30:00.000Z",
        "createdTime": "2025-01-10T08:00:00.000Z",
        "owners": [{"displayName": "Alice", "emailAddress": "alice@example.com"}],
        "lastModifyingUser": {"displayName": "Bob", "emailAddress": "bob@example.com"},
        "size": "12345",
    }
    ```

    `TestInfoTerse`:
    - `test_info_terse_output`: Patch `get_file_info` to return `MOCK_METADATA`, patch `export_doc` to return `"Hello world content"`. Call `cmd_info` with terse mode. Assert stdout contains `Title: Test Document`, `Owner: Alice`, `Modified: 2025-01-15`, `Words: 3`.
    - `test_info_terse_date_truncated`: Assert the modified date is `YYYY-MM-DD` format (10 chars), not full ISO.

    `TestInfoVerbose`:
    - `test_info_verbose_output`: Call with `verbose=True`. Assert stdout contains `Created:`, `Last editor: Bob`, `Type:`, `Size: 12345`.
    - `test_info_verbose_missing_size`: Patch metadata without `size` key. Assert stdout contains `Size: N/A`.

    `TestInfoJson`:
    - `test_info_json_output`: Call with `json=True`. Parse stdout as JSON. Assert contains `ok: true`, `title`, `owner`, `modified`, `words`.
    - `test_info_json_word_count_type`: Assert `words` field is an integer in JSON output.

    `TestInfoOwnerFallback`:
    - `test_info_owner_email_fallback`: Patch metadata with owner having `emailAddress` but no `displayName`. Assert owner shows email.
    - `test_info_owner_unknown`: Patch metadata with empty owners list. Assert owner shows "Unknown".

    `TestInfoNonExportableFile`:
    - `test_info_pdf_skips_word_count`: Patch `get_file_info` to return metadata with `"mimeType": "application/pdf"`. Do NOT patch `export_doc`. Call `cmd_info` in terse mode. Assert stdout contains `Words: N/A`. Assert `export_doc` was NOT called (verifies no export attempt on non-exportable files).
    - `test_info_form_skips_word_count`: Patch `get_file_info` to return metadata with `"mimeType": "application/vnd.google-apps.form"`. Do NOT patch `export_doc`. Call `cmd_info` in terse mode. Assert stdout contains `Words: N/A`. Assert `export_doc` was NOT called (Forms are not exportable to text/plain).
    - `test_info_drawing_skips_word_count`: Patch `get_file_info` to return metadata with `"mimeType": "application/vnd.google-apps.drawing"`. Do NOT patch `export_doc`. Call `cmd_info` in terse mode. Assert stdout contains `Words: N/A`. Assert `export_doc` was NOT called (Drawings only export to image formats, not text/plain).
    - `test_info_non_exportable_json`: Patch metadata with `"mimeType": "application/pdf"`, call with `json=True`. Parse stdout JSON. Assert `words` is `None` (null in JSON).
    - `test_info_export_failure_graceful`: Patch `get_file_info` to return metadata with `"mimeType": "application/vnd.google-apps.document"`. Patch `export_doc` to raise `GdocError("API error")`. Call `cmd_info` in terse mode. Assert stdout contains `Words: N/A` (graceful fallback, not a crash).

    `TestInfoErrors`:
    - `test_info_invalid_doc_id`: Call with `doc="!!invalid!!"`. Assert raises `GdocError` with exit_code 3.
    - `test_info_api_error`: Patch `get_file_info` to raise `GdocError`. Assert raises `GdocError`.
  </action>
  <verify>
    `.venv/bin/python -m pytest tests/test_cat.py tests/test_info.py -v`
    `.venv/bin/python -m pytest tests/ -v` (full suite, all tests pass)
  </verify>
  <done>
    All cat tests pass (7+ tests covering markdown/plain/json/comments-stub/errors). All info tests pass (14+ tests covering terse/verbose/json/owner-fallback/non-exportable-files/export-failure-fallback/errors). Full test suite green.
  </done>
</task>

</tasks>

<verification>
1. `gdoc cat some-doc-id` no longer returns exit code 4 (stub removed)
2. `gdoc info some-doc-id` no longer returns exit code 4 (stub removed)
3. `gdoc cat some-doc-id --comments` returns exit code 4 with ERR message (stub retained)
4. `tests/test_cat.py` has 7+ tests passing
5. `tests/test_info.py` has 14+ tests passing
6. `.venv/bin/python -m pytest tests/ -v` — all tests pass
7. `bash scripts/check-no-stubs.sh` — reports remaining stubs (cat --comments + other commands)
</verification>

<success_criteria>
- cmd_cat outputs raw content to stdout (no wrapper in terse/verbose modes)
- cmd_cat --json outputs {"ok": true, "content": "..."} JSON
- cmd_cat --comments returns stub exit code 4
- cmd_info outputs Title/Owner/Modified/Words in terse mode (Words: N/A for non-text-exportable files: PDFs, Forms, Drawings, etc.)
- cmd_info --verbose adds Created/Last editor/Type/Size
- cmd_info --json outputs flat metadata JSON (words: null for non-exportable files)
- cmd_info works on any Drive file, not just Google Docs editor files
- cmd_info gracefully falls back to Words: N/A if export_doc fails unexpectedly
- Invalid doc IDs produce exit code 3
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-phase-02/02-02-SUMMARY.md`
</output>
