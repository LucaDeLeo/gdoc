---
phase: 05-comments
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gdoc/api/comments.py
  - gdoc/state.py
  - gdoc/cli.py
  - tests/test_comments_api.py
  - tests/test_state.py
  - tests/test_comments_cmd.py
autonomous: true

must_haves:
  truths:
    - "User can list open comments with `gdoc comments DOC_ID`"
    - "User can list all comments including resolved with `gdoc comments DOC_ID --all`"
    - "User can add an unanchored comment with `gdoc comment DOC_ID \"text\"`"
    - "User can reply to a comment with `gdoc reply DOC_ID COMMENT_ID \"text\"`"
    - "User can resolve a comment with `gdoc resolve DOC_ID COMMENT_ID`"
    - "User can reopen a resolved comment with `gdoc reopen DOC_ID COMMENT_ID`"
  artifacts:
    - path: "gdoc/api/comments.py"
      provides: "Comment CRUD API wrappers"
      contains: "create_comment"
    - path: "gdoc/state.py"
      provides: "Comment state patch mechanism"
      contains: "comment_state_patch"
    - path: "gdoc/cli.py"
      provides: "Comment command handlers"
      contains: "cmd_comments"
    - path: "tests/test_comments_cmd.py"
      provides: "Comment command integration tests"
      min_lines: 100
  key_links:
    - from: "gdoc/cli.py"
      to: "gdoc/api/comments.py"
      via: "create_comment, create_reply, list_comments"
      pattern: "from gdoc\\.api\\.comments import"
    - from: "gdoc/cli.py"
      to: "gdoc/state.py"
      via: "comment_state_patch parameter"
      pattern: "comment_state_patch="
---

<objective>
Implement all comment CRUD commands (comments, comment, reply, resolve, reopen) with API layer extensions, state patch mechanism, and CLI handlers.

Purpose: Enables users to manage document comments through the CLI, covering requirements COMM-01 through COMM-06. This is the foundation for Phase 5 -- all comment operations except the annotated view.

Output: Six working comment commands with full test coverage, proper output formatting, and state tracking.
</objective>

<execution_context>
@/Users/luca/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luca/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-phase-05/CONTEXT.md
@.planning/phases/05-phase-05/05-RESEARCH.md
@gdoc/api/comments.py
@gdoc/cli.py
@gdoc/state.py
@gdoc/notify.py
@gdoc/format.py
@tests/test_comments_api.py
@tests/test_state.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: API layer extensions + state patch mechanism</name>
  <files>gdoc/api/comments.py, gdoc/state.py, tests/test_comments_api.py, tests/test_state.py</files>
  <action>
**gdoc/api/comments.py — Three changes:**

1. **Modify `list_comments` signature** to add `include_resolved: bool = True` and `include_anchor: bool = False` parameters.
   - Remove the fake `"includeResolved": True` from the API params dict (it is not a real Drive API v3 parameter — silently ignored. Per CONTEXT.md Decision #4 and RESEARCH pitfall #2).
   - When `include_anchor=True`, append `quotedFileContent(value),` to the `fields` string (before the closing `)`). This is only needed for `cat --comments`.
   - After fetching all pages, if `include_resolved is False`, filter client-side: `all_comments = [c for c in all_comments if not c.get("resolved", False)]`.
   - The `start_modified_time` parameter remains unchanged.

2. **Add `create_comment(file_id: str, content: str) -> dict`:**
   ```python
   def create_comment(file_id: str, content: str) -> dict:
       try:
           service = get_drive_service()
           result = service.comments().create(
               fileId=file_id,
               body={"content": content},
               fields="id, content, author(displayName, emailAddress), createdTime, resolved",
           ).execute()
           return result
       except HttpError as e:
           _translate_http_error(e, file_id)
   ```

3. **Add `create_reply(file_id: str, comment_id: str, content: str = "", action: str = "") -> dict`:**
   - Build body dict: if `content`, add `"content": content`. If `action`, add `"action": action`.
   - Fields: `"id, content, action, author(displayName, emailAddress), createdTime"`.
   - Wrap in try/except HttpError -> `_translate_http_error(e, file_id)`.
   - NOTE: Per research pitfall #3, `content` is required when no `action` is specified. The caller (CLI handler) is responsible for ensuring this.

**gdoc/state.py — Add `comment_state_patch` parameter:**

Modify `update_state_after_command` signature to accept `comment_state_patch: dict | None = None`. After the existing logic (lines 76-108) but BEFORE `save_state(doc_id, state)`:

```python
# Apply comment mutation patch (both quiet and non-quiet)
# Per CONTEXT.md Decision #10
if comment_state_patch:
    if "add_comment_id" in comment_state_patch:
        cid = comment_state_patch["add_comment_id"]
        if cid not in state.known_comment_ids:
            state.known_comment_ids.append(cid)
    if "add_resolved_id" in comment_state_patch:
        rid = comment_state_patch["add_resolved_id"]
        if rid not in state.known_resolved_ids:
            state.known_resolved_ids.append(rid)
    if "remove_resolved_id" in comment_state_patch:
        rid = comment_state_patch["remove_resolved_id"]
        state.known_resolved_ids = [x for x in state.known_resolved_ids if x != rid]
```

**Tests — extend test_comments_api.py:**
- `test_create_comment_success` — mock service, verify API call params (fileId, body, fields), return dict with id.
- `test_create_comment_auth_error` — mock HttpError 401, verify AuthError raised.
- `test_create_reply_with_content` — verify body has `content`, no `action`.
- `test_create_reply_with_action_resolve` — verify body has `action: "resolve"`, no `content`.
- `test_create_reply_with_action_reopen` — verify body has `action: "reopen"`.
- `test_list_comments_include_resolved_false` — verify client-side filtering removes resolved comments.
- `test_list_comments_include_anchor_true` — verify `quotedFileContent(value)` appears in fields string.

**Tests — extend test_state.py:**
- `test_comment_state_patch_add_comment_id` — verify ID appended to known_comment_ids.
- `test_comment_state_patch_add_resolved_id` — verify ID appended to known_resolved_ids.
- `test_comment_state_patch_remove_resolved_id` — verify ID removed from known_resolved_ids.
- `test_comment_state_patch_no_duplicate` — verify same ID not added twice.
- `test_comment_state_patch_none` — verify no-op when patch is None.
  </action>
  <verify>`.venv/bin/python -m pytest tests/test_comments_api.py tests/test_state.py -v` — all tests pass including new ones.</verify>
  <done>
- `create_comment` and `create_reply` exist with error translation and correct `fields` params.
- `list_comments` accepts `include_resolved` and `include_anchor` params; filters client-side; does NOT pass `includeResolved` to API.
- `update_state_after_command` accepts and applies `comment_state_patch` dict in both quiet and non-quiet modes.
- All new tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: CLI comment handlers + list formatting + integration tests</name>
  <files>gdoc/cli.py, tests/test_comments_cmd.py</files>
  <action>
**gdoc/cli.py — Implement 5 new handlers and modify parser:**

All handlers follow this pattern (matching cmd_edit/cmd_write conventions):
1. `doc_id = _resolve_doc_id(args.doc)`
2. `quiet = getattr(args, "quiet", False)`
3. Pre-flight: `from gdoc.notify import pre_flight; change_info = pre_flight(doc_id, quiet=quiet)`
4. API call (lazy import from gdoc.api.comments)
5. Output (terse vs json)
6. State update with comment_state_patch

**cmd_comments(args) -> int:**
- Makes its own FULL `list_comments` call with `start_modified_time=""` (never reuses pre-flight data — CONTEXT.md Decision #8).
- `include_resolved = getattr(args, "all", False)`
- Calls `list_comments(doc_id, include_resolved=include_resolved)`.
- Format output per spec (multi-line, per CONTEXT.md Decision #2):
  ```
  #ID [open|resolved] author@email YYYY-MM-DD
    "comment content"
    -> reply_author: "reply content"
  ```
  Author: use `emailAddress` or fall back to `displayName`.
  Date: truncate `createdTime` to `YYYY-MM-DD` (terse). In verbose mode, show full ISO timestamp.
  Replies: prefix with `->`, indent. Only show replies with `content` (skip action-only replies like resolve/reopen which have no user-visible content).
- `--json` mode: `format_json(comments=[...list of comment dicts...])`.
- State update: `update_state_after_command(doc_id, change_info, command="comments", quiet=quiet)` — no comment_state_patch for listing.
- Return 0.

**cmd_comment(args) -> int:**
- `text = args.text`
- `from gdoc.api.comments import create_comment`
- `result = create_comment(doc_id, text)`
- `new_id = result["id"]`
- Terse: `print(f"OK comment #{new_id}")`
- JSON: `format_json(id=new_id, status="created")`
- State: `comment_state_patch={"add_comment_id": new_id}`
- Return 0.

**cmd_reply(args) -> int:**
- `comment_id = args.comment_id`, `text = args.text`
- `from gdoc.api.comments import create_reply`
- `result = create_reply(doc_id, comment_id, content=text)`
- `reply_id = result["id"]`
- Terse: `print(f"OK reply on #{comment_id}")`
- JSON: `format_json(commentId=comment_id, replyId=reply_id, status="created")`
- State: no comment_state_patch (replies don't change ID sets — CONTEXT.md Decision #10).
- Return 0.

**cmd_resolve(args) -> int:**
- `comment_id = args.comment_id`
- `from gdoc.api.comments import create_reply`
- `result = create_reply(doc_id, comment_id, action="resolve")`
- Terse: `print(f"OK resolved comment #{comment_id}")`
- JSON: `format_json(id=comment_id, status="resolved")`
- State: `comment_state_patch={"add_resolved_id": comment_id}`
- Return 0.

**cmd_reopen(args) -> int:**
- `comment_id = args.comment_id`
- `from gdoc.api.comments import create_reply`
- `result = create_reply(doc_id, comment_id, action="reopen")`
- Terse: `print(f"OK reopened comment #{comment_id}")`
- JSON: `format_json(id=comment_id, status="reopened")`
- State: `comment_state_patch={"remove_resolved_id": comment_id}`
- Return 0.

**Parser changes in build_parser():**
- Wire `cmd_comments`, `cmd_comment`, `cmd_reply`, `cmd_resolve`, `cmd_reopen` as `set_defaults(func=...)` replacing `cmd_stub`.
- Add `--all` flag to `cat_p` (NOT in the mutually exclusive group — it only has effect when `--comments` is also set): `cat_p.add_argument("--all", action="store_true", help="Include resolved comments (with --comments)")`.

**tests/test_comments_cmd.py — New test file, comprehensive coverage per CONTEXT.md test plan:**

Mock fixtures: `mock_pre_flight` (returns ChangeInfo or None), `mock_create_comment`, `mock_create_reply`, `mock_list_comments`.

**Comment CRUD output tests (mock API):**
- `test_comment_ok_output` — `gdoc comment DOC "text"` stdout: `OK comment #NEW_ID`, exit 0.
- `test_comment_json_output` — `gdoc comment DOC "text" --json` → `{"ok": true, "id": "...", "status": "created"}`.
- `test_reply_ok_output` — stdout: `OK reply on #CID`, exit 0.
- `test_reply_json_output` — `{"ok": true, "commentId": "CID", "replyId": "RID", "status": "created"}`.
- `test_resolve_ok_output` — stdout: `OK resolved comment #CID`, exit 0.
- `test_resolve_json_output` — `{"ok": true, "id": "CID", "status": "resolved"}`.
- `test_reopen_ok_output` — stdout: `OK reopened comment #CID`, exit 0.
- `test_reopen_json_output` — `{"ok": true, "id": "CID", "status": "reopened"}`.
- `test_comment_api_error` — mock HttpError (e.g., 404) → `ERR:` on stderr, exit 1.
- `test_comment_auth_error` — mock 401 → exit 2.

**Resolved filtering tests:**
- `test_comments_default_calls_include_resolved_false` — verify `list_comments` called with `include_resolved=False`.
- `test_comments_all_calls_include_resolved_true` — verify `list_comments` called with `include_resolved=True`.
- `test_comments_quiet_no_preflight` — verify pre_flight NOT called, list_comments called directly.
- `test_comments_nonquiet_separate_api_call` — verify both pre_flight AND list_comments called (2 separate paths).

**Comments list output format tests:**
- `test_comments_terse_format` — verify multi-line output matches spec format (#ID [open] author date + indented content + replies).
- `test_comments_json_format` — verify JSON output structure.
- `test_comments_empty` — no comments → no output, exit 0.

**State update tests (mutation commands):**
- `test_comment_quiet_state_patch` — `--quiet`: known_comment_ids gains new ID, last_comment_check unchanged.
- `test_resolve_quiet_state_patch` — `--quiet`: known_resolved_ids gains ID, last_comment_check unchanged.
- `test_reopen_quiet_state_patch` — `--quiet`: known_resolved_ids loses ID, last_comment_check unchanged.
- `test_reply_quiet_no_state_change` — `--quiet`: no ID set changes.
- `test_comment_nonquiet_preflight_then_patch` — non-quiet: pre-flight merged IDs written, THEN patch adds new comment ID.
- `test_resolve_nonquiet_preflight_then_patch` — non-quiet: pre-flight merged IDs written, THEN patch adds resolved ID.
- `test_reopen_nonquiet_preflight_then_patch` — non-quiet: pre-flight merged IDs written, THEN patch removes resolved ID.
  </action>
  <verify>`.venv/bin/python -m pytest tests/test_comments_cmd.py -v` — all tests pass. Then `.venv/bin/python -m pytest tests/ -v` — full suite passes, no regressions.</verify>
  <done>
- All 5 comment subparsers wired to real handlers (no more cmd_stub for comment commands).
- `gdoc comments DOC` lists open comments in multi-line spec format. `--all` includes resolved.
- `gdoc comment DOC "text"` outputs `OK comment #ID`. JSON mode works.
- `gdoc reply DOC CID "text"` outputs `OK reply on #CID`. JSON mode works.
- `gdoc resolve DOC CID` outputs `OK resolved comment #CID`. JSON mode works.
- `gdoc reopen DOC CID` outputs `OK reopened comment #CID`. JSON mode works.
- State patches applied correctly in both quiet and non-quiet modes.
- `--all` flag added to cat subparser for future use by Plan 05-02.
- All tests pass (existing + new).
  </done>
</task>

</tasks>

<verification>
```bash
# All tests pass
.venv/bin/python -m pytest tests/ -v

# No stubs remain for comment commands
bash scripts/check-no-stubs.sh

# Verify comment commands are wired (not using cmd_stub)
grep -n "cmd_stub" gdoc/cli.py
# Should only show cmd_stub definition and share/new/cp assignments (Phase 6 stubs)

# Quick smoke test of parser (no API calls)
.venv/bin/python -m gdoc comments --help
.venv/bin/python -m gdoc comment --help
.venv/bin/python -m gdoc reply --help
.venv/bin/python -m gdoc resolve --help
.venv/bin/python -m gdoc reopen --help
```
</verification>

<success_criteria>
- All comment CRUD commands produce correct terse and JSON output.
- `comments` command makes its own full list_comments call (not reusing pre-flight data).
- Client-side resolved filtering works (--all flag).
- State patches correctly update known_comment_ids and known_resolved_ids.
- last_comment_check does NOT advance in quiet mode for mutation commands.
- No regressions in existing test suite.
</success_criteria>

<output>
After completion, create `.planning/phases/05-phase-05/05-01-SUMMARY.md`
</output>
