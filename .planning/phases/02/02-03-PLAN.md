---
phase: 02-read-operations
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - gdoc/cli.py
  - tests/test_ls.py
  - tests/test_find.py
  - tests/test_cli.py
autonomous: true

must_haves:
  truths:
    - "gdoc ls prints tab-separated ID, TITLE, MODIFIED columns for root folder files"
    - "gdoc ls FOLDER_ID lists files in that specific folder"
    - "gdoc ls --type docs filters to Google Docs only"
    - "gdoc ls --type sheets filters to Google Sheets only"
    - "gdoc ls --verbose adds TYPE column to output"
    - "gdoc ls --json outputs {ok: true, files: [...]}"
    - "gdoc find 'query' searches by name and content, outputs same format as ls"
    - "gdoc find handles single quotes and backslashes in search query"
  artifacts:
    - path: "gdoc/cli.py"
      provides: "cmd_ls, cmd_find handlers"
      contains: "def cmd_ls"
    - path: "tests/test_ls.py"
      provides: "ls command tests"
    - path: "tests/test_find.py"
      provides: "find command tests"
  key_links:
    - from: "gdoc/cli.py cmd_ls"
      to: "gdoc/api/drive.py list_files"
      via: "lazy import and function call"
      pattern: "from gdoc.api.drive import list_files"
    - from: "gdoc/cli.py cmd_find"
      to: "gdoc/api/drive.py search_files"
      via: "lazy import and function call"
      pattern: "from gdoc.api.drive import search_files"
    - from: "gdoc/cli.py cmd_ls"
      to: "gdoc/util.py extract_doc_id"
      via: "_resolve_doc_id for folder_id argument"
      pattern: "_resolve_doc_id"
---

<objective>
Implement `ls` and `find` CLI commands for listing and searching Drive files.

Purpose: These commands let agents discover documents — `ls` for browsing folders and `find` for searching by name or content. Both share the same tab-separated output format and use the `list_files`/`search_files` wrappers from Plan 01.

Output: Working `cmd_ls` and `cmd_find` handlers in `cli.py`, comprehensive tests in `test_ls.py` and `test_find.py`.
</objective>

<execution_context>
@/Users/luca/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luca/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02/CONTEXT.md
@.planning/phases/02/02-01-SUMMARY.md
@.planning/phases/02/02-02-SUMMARY.md
@gdoc/cli.py
@gdoc/api/drive.py
@gdoc/format.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement cmd_ls and cmd_find in cli.py</name>
  <files>
    gdoc/cli.py
    tests/test_cli.py
  </files>
  <action>
    **1. Add shared `_format_file_list` helper** (in cli.py, used by both ls and find):
    ```python
    def _format_file_list(files: list[dict], mode: str) -> str:
        """Format a list of file dicts for output."""
        ...
    ```
    - **Terse mode:** For each file, output `ID\tTITLE\tMODIFIED` per line. Modified date truncated to `YYYY-MM-DD` (first 10 chars of `modifiedTime`). Lines joined with `\n`.
    - **Verbose mode:** For each file, output `ID\tTITLE\tMODIFIED\tTYPE` per line. Modified date kept as full ISO 8601. TYPE is the raw `mimeType` value.
    - **JSON mode:** Return `format_json(files=files)` — passes the raw list of file dicts through. Import `format_json` from `gdoc.format`.
    - Handle empty file list: return empty string for terse/verbose, return `format_json(files=[])` for JSON.

    **2. Add `cmd_ls` handler:**
    - Lazy import: `from gdoc.api.drive import list_files`
    - Build query parts list, then join with ` and `:
      - If `args.folder_id`: `folder_id = _resolve_doc_id(args.folder_id)` then add `f"'{folder_id}' in parents"`
      - If no `args.folder_id`: add `"'root' in parents"`
      - Always add: `"trashed=false"`
      - Type filter from `args.type`:
        - `"docs"`: add `"mimeType='application/vnd.google-apps.document'"`
        - `"sheets"`: add `"mimeType='application/vnd.google-apps.spreadsheet'"`
        - `"all"` (default): add nothing
    - Call: `files = list_files(query)`
    - Output: `mode = get_output_mode(args)`, then `output = _format_file_list(files, mode)`, then `if output: print(output)`
    - Return 0

    **3. Add `cmd_find` handler:**
    - Lazy import: `from gdoc.api.drive import search_files`
    - Call: `files = search_files(args.query)`
    - Output: same as ls — `mode = get_output_mode(args)`, `output = _format_file_list(files, mode)`, `if output: print(output)`
    - Return 0

    **4. Wire commands in `build_parser()`:**
    - Change `ls_p.set_defaults(func=cmd_stub)` to `ls_p.set_defaults(func=cmd_ls)`
    - Change `find_p.set_defaults(func=cmd_stub)` to `find_p.set_defaults(func=cmd_find)`

    **5. Update `tests/test_cli.py`:**
    - Remove `test_ls_stub` and `test_find_stub` from `TestExitCode4OnStubs` (no longer stubs)
    - If `TestExitCode4OnStubs` class becomes empty after removing all stub tests for implemented commands, keep at least one stub test for a still-stubbed command (e.g., `test_edit_stub` that tests `gdoc edit doc old new`)
    - Keep `test_stub_error_prefix` in `TestErrorFormat` but point it at a still-stubbed command if `ls` was the one being tested there. Use e.g. `run_gdoc("edit", "doc", "old", "new")` instead.
  </action>
  <verify>
    `.venv/bin/python -c "from gdoc.cli import cmd_ls, cmd_find; print('handlers OK')"`
    `.venv/bin/python -m pytest tests/test_cli.py -v` (existing tests still pass with stub tests updated)
  </verify>
  <done>
    `cmd_ls` and `cmd_find` are wired in `build_parser()`. Both build correct Drive API queries. Output formatting handles terse/verbose/json modes. Stub tests updated for still-stubbed commands. CLI tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test ls and find commands</name>
  <files>
    tests/test_ls.py
    tests/test_find.py
  </files>
  <action>
    Use `unittest.mock.patch` to mock `gdoc.api.drive` functions. Test at the command handler level using `cmd_ls(args)` / `cmd_find(args)` with `SimpleNamespace` args, capturing stdout with `capsys`.

    Mock `gdoc.api.get_drive_service` in all tests to prevent real service creation.

    **Shared test data:**
    ```python
    MOCK_FILES = [
        {
            "id": "doc1",
            "name": "Meeting Notes",
            "mimeType": "application/vnd.google-apps.document",
            "modifiedTime": "2025-01-15T10:30:00.000Z",
        },
        {
            "id": "sheet1",
            "name": "Budget 2025",
            "mimeType": "application/vnd.google-apps.spreadsheet",
            "modifiedTime": "2025-01-14T09:00:00.000Z",
        },
    ]
    ```

    **1. Create `tests/test_ls.py`:**

    `TestLsTerse`:
    - `test_ls_terse_output`: Patch `list_files` to return `MOCK_FILES`. Call `cmd_ls` with default args (`folder_id=None, type="all", json=False, verbose=False`). Assert stdout contains `doc1\tMeeting Notes\t2025-01-15` and `sheet1\tBudget 2025\t2025-01-14` (tab-separated, date truncated).
    - `test_ls_empty_result`: Patch `list_files` to return `[]`. Assert stdout is empty (no output).
    - `test_ls_default_query_root`: Patch `list_files`. Call with no folder_id. Assert `list_files` was called with a query containing `'root' in parents` and `trashed=false`.

    `TestLsTypeFilter`:
    - `test_ls_type_docs`: Call with `type="docs"`. Assert query contains `mimeType='application/vnd.google-apps.document'`.
    - `test_ls_type_sheets`: Call with `type="sheets"`. Assert query contains `mimeType='application/vnd.google-apps.spreadsheet'`.
    - `test_ls_type_all`: Call with `type="all"`. Assert query does NOT contain `mimeType=`.

    `TestLsFolderFilter`:
    - `test_ls_with_folder_id`: Call with `folder_id="folder123"`. Assert query contains `'folder123' in parents` and does NOT contain `'root' in parents`.
    - `test_ls_with_folder_url`: Call with `folder_id="https://drive.google.com/drive/folders/folder123"`. Assert query contains `'folder123' in parents`.

    `TestLsVerbose`:
    - `test_ls_verbose_output`: Call with `verbose=True`. Assert stdout lines have 4 tab-separated columns (ID, TITLE, MODIFIED, TYPE). Assert modified time is full ISO 8601 (not truncated).

    `TestLsJson`:
    - `test_ls_json_output`: Call with `json=True`. Parse stdout as JSON. Assert `{"ok": true, "files": [...]}` with correct file objects.
    - `test_ls_json_empty`: Call with `json=True` and empty file list. Assert `{"ok": true, "files": []}`.

    **2. Create `tests/test_find.py`:**

    `TestFindBasic`:
    - `test_find_basic_search`: Patch `search_files` to return `MOCK_FILES`. Call `cmd_find` with `query="meeting"`. Assert `search_files` called with `"meeting"`. Assert stdout contains tab-separated output.
    - `test_find_empty_result`: Patch `search_files` to return `[]`. Assert stdout is empty.

    `TestFindOutputFormat`:
    - `test_find_terse_matches_ls`: Patch `search_files` to return `MOCK_FILES`. Assert output format is identical to ls terse (tab-separated, 3 columns, date truncated).
    - `test_find_verbose`: Call with `verbose=True`. Assert 4 columns with TYPE.
    - `test_find_json`: Call with `json=True`. Parse stdout. Assert `{"ok": true, "files": [...]}`.

    `TestFindSpecialChars`:
    - `test_find_with_quotes`: Call with `query="it's"`. Assert `search_files` called with `"it's"` (escaping happens inside `search_files`, not in handler).
    - `test_find_with_backslash`: Call with `query="path\\to"`. Assert `search_files` called with `"path\\to"`.
  </action>
  <verify>
    `.venv/bin/python -m pytest tests/test_ls.py tests/test_find.py -v`
    `.venv/bin/python -m pytest tests/ -v` (full suite, all tests pass)
  </verify>
  <done>
    All ls tests pass (10+ tests covering terse/verbose/json/type-filter/folder-filter/empty). All find tests pass (7+ tests covering basic/output-format/special-chars). Full test suite green.
  </done>
</task>

</tasks>

<verification>
1. `gdoc ls` no longer returns exit code 4 (stub removed)
2. `gdoc find "query"` no longer returns exit code 4 (stub removed)
3. `gdoc ls` builds query with `'root' in parents and trashed=false`
4. `gdoc ls FOLDER_ID` uses `'{folder_id}' in parents`
5. `gdoc ls --type docs` adds mimeType filter
6. Output is tab-separated with correct column count for each mode
7. `tests/test_ls.py` has 10+ tests passing
8. `tests/test_find.py` has 7+ tests passing
9. `.venv/bin/python -m pytest tests/ -v` — all tests pass
10. `bash scripts/check-no-stubs.sh` — reports remaining stubs (cat --comments, edit, write, comments, etc.)
</verification>

<success_criteria>
- cmd_ls builds correct Drive query with folder, type, and trash filters
- cmd_ls outputs tab-separated ID\tTITLE\tMODIFIED (terse) or +TYPE (verbose)
- cmd_ls --json outputs {"ok": true, "files": [...]}
- cmd_find delegates to search_files with raw query (escaping in API layer)
- cmd_find output format matches ls exactly
- Folder URLs resolved via extract_doc_id
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02/02-03-SUMMARY.md`
</output>
